---
title: "Calculate species vulnerability from traits"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)

source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

```

# Summary

Read in Excel spreadsheets of taxonomic traits filled in by taxon experts.  Process into a long/tidy format with checks on validity of category values.  Identify categories that were assigned non-valid values.

# Data

`_raw_data/all_taxa_trait_data.xlsx` is the raw workbook prepared by Nathalie Butt from the various submissions of the taxa-group experts.  This has been processed and cleaned to `_data/spp_traits_valid.csv`.

`excel_files/trait_stressor_sens_tidy.xlsx` is a workbook with each sheet indicating a stressor, and sensitivity scores for each trait with respect to that stressor.

# Methods

## Use scored sensitivity traits to stressors against species scored to traits

Set up a function to consistently clean trait values.  Trait values in the species trait file are already cleaned and adjusted in many cases to get around mismatches; they are generally lower case, no punctuation except for greater/less than signs.

This function also cleans up category and trait names for consistency.  All lower case, punctuation and spaces replaced with underscores.  Again, the species trait file is already cleaned in this manner.
```{r}
clean_traits <- function(df, overwrite_clean_col = FALSE) {
  df <- df %>% 
    mutate(category = str_replace_all(category, '[^A-Za-z0-9]+', '_') %>% tolower(),
           category = str_replace_all(category, '^_|_$', ''),
           trait    = str_replace_all(trait, '[^A-Za-z0-9]+', '_') %>% tolower(),
           trait    = str_replace_all(trait, '^_|_$', ''))
  if(!overwrite_clean_col & ('trait_value' %in% names(df))) {
      return(df) ### without overwriting existing trait_value
  }
  if(overwrite_clean_col & ('trait_value' %in% names(df))) {
    x <- readline(prompt = 'Overwriting existing trait_value column? y/n ')
    if(str_detect(x, '^n')) stop('dammit!')
  }
  ### overwrite existing, or add new
  df <- df %>%
    mutate(trait_value = str_replace_all(tolower(trait_value), '[^0-9a-z<>]', ''))
  
  return(df)
}

assign_rank_scores <- function(x) {
  y <- tolower(as.character(x))
  z <- case_when(!is.na(as.numeric(x)) ~ as.numeric(x),
                 str_detect(y, '^n')   ~ 0.00, ### none, NA, no
                 str_detect(y, '^lo')  ~ 0.33,
                 str_detect(y, '^med') ~ 0.67,
                 str_detect(y, '^hi')  ~ 1.00,
                 str_detect(y, '^y')   ~ 1.00, ### yes
                 TRUE ~ NA_real_)
  return(z)
}
```

Since the species trait file is already cleaned, DO NOT use the `clean_traits` function - it will overwrite the `trait_value` column.
```{r}
spp_traits <- read_csv('_data/spp_traits_valid.csv')

```

```{r}
trait_str_sens_files <- list.files(here('trait_stressor_rankings'), 
                                    pattern = 'trait_stressor_sens',
                                    full.names = TRUE)

sens_traits_list <- vector('list', length = length(trait_str_sens_files)) %>%
  setNames(trait_str_sens_files)

for(f in trait_str_sens_files) {
  layers <- readxl::excel_sheets(f)
  
  sens_trait_scores <- lapply(layers,
        FUN = function(l) { # l <- layers[1]
          df <- readxl::read_excel(f, sheet = l) %>%
            mutate(stressor = tolower(l),
                   sens_score_orig = as.character(sens_score),
                   sens_score = assign_rank_scores(sens_score))
          return(df)
        }) %>%
    bind_rows() %>%
    clean_traits() %>%
    ### drop these - going into other categories - we'll change the sheets later
    filter(!str_detect(category, 'spatial_scale|breeding_nesting|foraging_range')) 
  
  sens_traits_list[[f]] <- sens_trait_scores
}

str_sens_trait_scores <- bind_rows(sens_traits_list) %>%
  select(category, trait, trait_value, sens_score, stressor, trait_value)

### To score for a species/stressor combo, first average the score for
### each trait (e.g. if multiple values were noted, just give the average)
### then sum across all traits
spp_sens <- spp_traits %>%
  left_join(str_sens_trait_scores, by = c('category', 'trait', 'trait_value')) %>%
  filter(!is.na(stressor)) %>%
  group_by(spp_gp, stressor, taxon, trait) %>%
  summarize(sens_score = mean(sens_score, na.rm = TRUE)) %>%
  group_by(spp_gp, stressor, taxon) %>%
  summarize(sens_score = sum(sens_score, na.rm = TRUE)) %>%
  ungroup()
```

### Sensitivity by species group and stressor

```{r}
p <- ggplot(spp_sens, aes(x = stressor, y = sens_score)) +
  geom_jitter(size = 1, alpha = .6) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5)) +
  facet_wrap(~ taxon)

ggsave(here('figs/spp_sens_scores.png'), height = 6, width = 6, dpi = 300)

knitr::include_graphics(here('figs/spp_sens_scores.png'))
```

### Sensitivity to top three stressors by taxon
```{r}
top_3_sens <- spp_sens %>%
  group_by(taxon, stressor) %>%
  summarize(sens_score = mean(sens_score)) %>%
  arrange(desc(sens_score)) %>%
  group_by(taxon) %>%
  filter(sens_score >= nth(sens_score, 3))

DT::datatable(top_3_sens)
```

## Score general adaptive capacity

General adaptive capacity traits are basically related to the overall population's resilience in the face of a threat.  Large extents of occurrence, large population sizes, presence of multiple subpopulations, and reproductive strategies fall into this category.

``` {r}
adcap_gen_traits_file <- here('trait_stressor_rankings/trait_stressor_adcap_general.xlsx')

adcap_gen_traits <- readxl::read_excel(adcap_gen_traits_file) %>%
  # filter(trait != 'max age' & trait != 'if one/few, size') %>%
  mutate(adcap_score_orig = as.character(adcap_score),
         adcap_score = assign_rank_scores(adcap_score)) %>%
  filter(!is.na(adcap_score)) %>%
  clean_traits()

spp_adcap_gen <- spp_traits %>%
  left_join(adcap_gen_traits, by = c('category', 'trait', 'trait_value')) %>%
  group_by(spp_gp, taxon) %>%
  summarize(adcap_gen_score = sum(adcap_score, na.rm = TRUE)) %>%
  ungroup()
  
# hist(spp_adcap_gen$adcap_gen_score)

```

```{r}
p <- ggplot(spp_adcap_gen, aes(x = taxon, y = adcap_gen_score)) +
  geom_jitter(size = 1, alpha = .6, width = .2) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))

ggsave(here('figs/spp_adcap_gen_scores.png'), height = 6, width = 6, dpi = 300)

knitr::include_graphics(here('figs/spp_adcap_gen_scores.png'))
```

* Median: `r median(spp_adcap_gen$adcap_gen_score)`
* Mean: `r mean(spp_adcap_gen$adcap_gen_score)`
* Standard Deviation: `r sd(spp_adcap_gen$adcap_gen_score)`


## Score specific adaptive capacity

Specific adaptive capacity traits are basically related to an organism's ability to avoid or mitigate exposure, primarily through movement and larval dispersal.

``` {r}
adcap_spec_traits_files <- list.files(here('trait_stressor_rankings'), 
                                    pattern = 'trait_stressor_adcap_spec',
                                    full.names = TRUE)

adcap_spec_traits_list <- vector('list', length = length(adcap_spec_traits_files)) %>%
  setNames(adcap_spec_traits_files)

for(f in adcap_spec_traits_files) {
  layers <- readxl::excel_sheets(f)
  spec_traits <- lapply(layers,
          FUN = function(l) { # l <- layers[1]
            df <- readxl::read_excel(f, sheet = l) %>%
              mutate(stressor = tolower(l),
                     adcap_score_orig = as.character(adcap_score),
                     adcap_score = assign_rank_scores(adcap_score))
            return(df)
          }) %>%
    bind_rows() %>%
    clean_traits() %>%
    filter(!str_detect(category, 'spatial_scale')) ### drop exposure traits
  
  adcap_spec_traits_list[[f]] <- spec_traits
}

adcap_spec_traits <- bind_rows(adcap_spec_traits_list)

spp_adcap_spec <- spp_traits %>%
  left_join(adcap_spec_traits, by = c('category', 'trait', 'trait_value')) %>%
  filter(!is.na(stressor)) %>%
  group_by(spp_gp, stressor, taxon) %>%
  summarize(adcap_spec_score = sum(adcap_score, na.rm = TRUE)) %>%
  ungroup()
  
# hist(spp_adcap_spec$adcap_spec_score)
# median(spp_adcap_spec$adcap_spec_score); mean(spp_adcap_spec$adcap_spec_score); sd(spp_adcap_spec$adcap_spec_score)
adcap_spec_sum <- spp_adcap_spec %>%
  group_by(stressor) %>%
  summarize(median = median(adcap_spec_score, na.rm = TRUE),
            mean   = mean(adcap_spec_score, na.rm = TRUE),
            sd     = sd(adcap_spec_score, na.rm = TRUE))
```

### specific adaptive capacity by stressor and species group

```{r}
p <- ggplot(spp_adcap_spec, aes(x = stressor, y = adcap_spec_score)) +
  geom_jitter(size = 1, alpha = .6, width = .2, height = .05) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5)) +
  facet_wrap( ~ taxon)

ggsave(here('figs/spp_adcap_spec_scores.png'), height = 6, width = 6, dpi = 300)

knitr::include_graphics(here('figs/spp_adcap_spec_scores.png'))
```

`r knitr::kable(adcap_spec_sum)`

### Adaptive capacity to top three stressors by taxon
```{r}
top_3_adcap <- spp_adcap_spec %>%
  group_by(taxon, stressor) %>%
  summarize(adcap_score = mean(adcap_spec_score)) %>%
  arrange(desc(adcap_score)) %>%
  group_by(taxon) %>%
  filter(adcap_score >= nth(adcap_score, 3))

DT::datatable(top_3_adcap)
```

## Assign exposure potential modifier

Exposure potential modifier checks whether the depth and oceanic zones of the stressor match with the depth and oceanic zones of the species.  These fall into the "spatial scale" category with the exception of EOO.

```{r}
exp_traits_files <- list.files(here('trait_stressor_rankings'), 
                                    pattern = 'trait_stressor_adcap_spec',
                                    full.names = TRUE)

exp_traits_list <- vector('list', length = length(exp_traits_files)) %>%
  setNames(exp_traits_files)

for(f in exp_traits_files) {
  layers <- readxl::excel_sheets(f)
  str_exp <- lapply(layers,
          FUN = function(l) { # l <- layers[1]
            df <- readxl::read_excel(f, sheet = l) %>%
              mutate(stressor = tolower(l),
                     adcap_score_orig = as.character(adcap_score),
                     adcap_score = assign_rank_scores(adcap_score))
            return(df)
          }) %>%
    bind_rows() %>%
    clean_traits() %>%
    rename(exposure = adcap_score) %>%
    filter(str_detect(category, 'spatial_scale')) ### include only exposure traits
  
  exp_traits_list[[f]] <- str_exp
}
  
str_exposure <- bind_rows(exp_traits_list)

spp_exposure <- spp_traits %>%
  left_join(str_exposure, by = c('category', 'trait', 'trait_value')) %>%
  filter(!is.na(stressor)) %>%
  group_by(spp_gp, stressor, taxon) %>%
  summarize(exposure_mod = as.integer(sum(exposure, na.rm = TRUE) > 0)) %>%
  ungroup()  %>%
  arrange(stressor, taxon)
  
non_exposures <- spp_exposure %>% 
  filter(exposure_mod == 0) %>% 
  group_by(taxon, stressor) %>% 
  summarize(n_spp_gps = n_distinct(spp_gp)) %>%
  arrange(stressor, desc(n_spp_gps))
```

### These species are not listed as potential exposure to these stressors: 

`r knitr::kable(non_exposures)`

Note: this is exposure potential only, based on overlap between species presence and stressor presence - nothing about sensitivity or actual exposure.  Check that these logic out.

# Combine scores

We will try a calculation for vulnerability $V$ of species $i$ to stressor $j$ that basically looks like this:

$$\text{sensitivity score } S_{i,j} = \mathbf{s}_j^T \mathbf{t}_i$$
based on a vector $\mathbf{s}_j$ of trait-based sensitivity to stressor $j$, and vector $\mathbf{t}_i$ of traits of species $i$;

$$\text{specific adaptive capacity score } K_{i,j} = \mathbf{k}_j^T \mathbf{t}_i$$
based on vector $\mathbf{k}_j$ of trait-based specific adaptive capacity to stressor $j$;
$$\text{general adaptive capacity score } G_{i} = \mathbf{g}^T \mathbf{t}_i$$
based on vector $\mathbf{g}$ of trait-based general adaptive capacity; 

$$\text{exposure potential modifier } E_{i,j} = \begin{cases} 1 \text{ when }\mathbf{e}_j^T \mathbf{t}_i > 0\\ 0 \text{ else} \end{cases}$$
based on vector $\mathbf{e}_j$ of trait-based presence of stressor $j$ (i.e. depth zones and ocean zones in which stressor occurs).

$$\text{vulnerability } V_{i,j} = \frac{S_{i,j} / {S_j}'}{1 + G_i/ {G}' + K_{i,j}/ {K_j}'} \times E_{i,j}$$
Each component ($S_{i,j}, G_i, K_{i,j}$) is normalized by a reference value ($S_{j}', G', K_{j}'$ using mean, median, max, etc) for that component for that stressor across all species.  Note: median risks referencing to zero for some stressors with few sensitivities (e.g. light pollution); mean risks having a very low reference for the same.  Max risks being driven by an outlier, but here the sensitivity scores are generally capped at some low-ish value since there are a finite number of traits that can confer sensitivity.  Therefore, we will use max as the reference point.  We may wish to consider max possible, which may differ from max observed, in a future iteration?

For species groups with NA in specific adaptive capacity, force to zero (no matching adaptive traits); for species with NA in exposure potential, force to 1 (assume exposure potential).

These results will be saved by species group for now, for future matching to the species level.

```{r}

### Check that all stressors are matched to ensure proper combining of scores

exp_strs <- spp_exposure$stressor %>% unique()
sens_strs <- spp_sens$stressor %>% unique()
adcap_strs <- spp_adcap_spec$stressor %>% unique()

if(!all(exp_strs %in% sens_strs) | !all(sens_strs %in% exp_strs)) {
  stop('Mismatch between exposure traits and sensitivity traits!')
}
if(!all(adcap_strs %in% sens_strs) | !all(sens_strs %in% adcap_strs)) {
  stop('Mismatch between ad cap traits and sensitivity traits!')
}
if(!all(exp_strs %in% adcap_strs) | !all(adcap_strs %in% exp_strs)) {
  stop('Mismatch between exposure traits and ad cap traits!')
}
```

```{r}
spp_vulnerability <- spp_sens %>%
  left_join(spp_adcap_gen, by = c('taxon', 'spp_gp')) %>%
  left_join(spp_adcap_spec, by = c('taxon', 'spp_gp', 'stressor')) %>%
  left_join(spp_exposure, by = c('taxon', 'spp_gp', 'stressor')) %>%
  ### fix NAs
  mutate(adcap_spec_score = ifelse(is.na(adcap_spec_score), 0, adcap_spec_score),
         exposure_mod     = ifelse(is.na(exposure_mod), 1, exposure_mod)) %>%
  ### calculate means.  General adcap is overall; specific adcap and sensitivity are by stressor
  group_by(stressor) %>%
  mutate(max_adcap_spec = max(adcap_spec_score),
         max_sens = max(sens_score)) %>%
  ungroup() %>%
  mutate(max_adcap_gen = max(adcap_gen_score)) %>%
  ### rescale components
  mutate(sens_rescale = sens_score / max_sens,
         adcap_gen_rescale = adcap_gen_score / max_adcap_gen,
         adcap_spec_rescale = adcap_spec_score / max_adcap_spec) %>%
  ### note any stressors with zero for max (e.g. adcap for entanglement),
  ### will result in a NaN - convert the rescaled score to zero
  mutate(sens_rescale = ifelse(is.na(sens_rescale), 0, sens_rescale),
         adcap_gen_rescale = ifelse(is.na(adcap_gen_rescale), 0, adcap_gen_rescale),
         adcap_spec_rescale = ifelse(is.na(adcap_spec_rescale), 0, adcap_spec_rescale)) %>%
  ### mash 'em all together
  mutate(vuln = sens_rescale / (1 + adcap_gen_rescale + adcap_spec_rescale) * exposure_mod)

write_csv(spp_vulnerability, here('_output/spp_gp_vulnerability.csv'))
```

### Vulnerability by spp group and stressor

``` {r}

vuln_plot <- ggplot(spp_vulnerability, aes(x = stressor, y = vuln)) +
  ggtheme_plot() +
  geom_jitter(size = 1, alpha = .6, width = .2, height = .02) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        strip.background = element_rect(fill = 'grey90')) +
  facet_wrap(~ taxon) +
  labs(title = 'rescale using max reference point')

ggsave(plot = vuln_plot, filename = here('figs/vuln_plot.png'), width = 8, height = 8, dpi = 300)
knitr::include_graphics(here('figs/vuln_plot.png'))

```

### Vulnerability to top three stressors by taxon
```{r}
top_3_vuln <- spp_vulnerability %>%
  group_by(taxon, stressor) %>%
  summarize(vuln = mean(vuln)) %>%
  group_by(taxon) %>%
  arrange(taxon, desc(vuln)) %>%
  filter(vuln >= nth(vuln, 3))

knitr::kable(top_3_vuln)
```

## examine components by taxon and stressor

```{r, eval = FALSE}
spp_vuln_summary <- spp_vulnerability %>%
  group_by(taxon, stressor) %>%
  summarize(n_spp = n_distinct(spp_gp),
            sens_mean = mean(sens_rescale),
            sens_sd   = sd(sens_rescale),
            gen_mean  = mean(adcap_gen_rescale),
            gen_sd    = sd(adcap_gen_rescale),
            spec_mean = mean(adcap_spec_rescale),
            spec_sd   = sd(adcap_spec_rescale)) %>%
  ungroup() %>%
  gather(component1, mean, ends_with('mean')) %>%
  gather(component2, sd, ends_with('sd')) %>%
  filter(str_sub(component1, 1, 4) == str_sub(component2, 1, 4)) %>%
  mutate(component = str_replace(component1, '_mean', '')) %>%
  select(-component1, -component2)
            
ggplot(spp_vuln_summary, aes(x = stressor, color = component, group = component)) +
  ggtheme_plot() +
  geom_point(aes(y = mean), position = position_dodge(width = .8)) +
  geom_linerange(aes(ymin = mean - sd, ymax = mean + sd),
                 position = position_dodge(width = .8)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        strip.background = element_rect(fill = 'grey90')) +
  facet_wrap(~ taxon, scales = 'free_y')
```

