---
title: "Upstream-downstream taxa vulnerability gapfill"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)

source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

```

# Summary

Using taxonomic trees from WoRMS and the `taxize` package, we will try filling vulnerabilities for non-scored species using an upstream-downstream method.

# Methods

* For a given rank, calculate distribution parameters based on all known downstream spp (e.g., for genus, calc mean and sd based on all scored spp)
* Then assign those back down to unknown species at the species level.
* For data given at the genus level (or above), this effectively automatically gapfills all species in the genus.
* Repeat for higher levels

## Load expanded vulnerability scores

```{r load expanded vuln scores from script 4}
match_spp <- read_csv(here('int/spp_match_downfill.csv'))
spp_vuln  <- read_csv(here('int/vuln_downfill_only.csv'))

match_vuln_df <- match_spp %>%
  inner_join(spp_vuln, by = 'spp_id')
```

## Assemble full spp table from WoRMS

``` {r assemble full spp taxonomic table from WoRMS}
p_from_k <- read_csv(here('int/phylum_from_kingdom_worms.csv')) %>%
  filter(!is.na(id))
c_from_p <- read_csv(here('int/class_from_phylum_worms.csv')) %>%
  filter(!is.na(id))
o_from_c <- read_csv(here('int/order_from_class_worms.csv')) %>%
  filter(!is.na(id))
f_from_o <- read_csv(here('int/family_from_order_worms.csv')) %>%
  filter(!is.na(id))
g_from_f <- read_csv(here('int/genus_from_family_worms.csv')) %>%
  filter(!is.na(id))
s_from_g <- read_csv(here('int/species_from_genus_worms.csv')) %>%
  filter(!is.na(id))

rank_lvls <- c('kingdom', 'phylum', 'class', 'order', 'family', 'genus', 'species')

### create long df to match at any level
spp_df_long <- bind_rows(s_from_g, g_from_f, f_from_o, o_from_c, c_from_p, p_from_k) %>%
  mutate(rank = factor(rank, levels = rank_lvls)) %>%
  filter(!is.na(name))

full_class_file <- here('_data/spp_complete_classifications_worms.csv')
if(!file.exists(full_class_file)) {
  ### write this out; this can be used to recreate full classifications later
  write_csv(spp_df_long, full_class_file)
}

### create wide for complete classification for each species
spp_df_wide <- s_from_g %>%
  select(genus = parent, species = name) %>%
  left_join(g_from_f %>% select(family = parent, genus = name), 
            by = c('genus')) %>%
  left_join(f_from_o %>% select(order = parent, family = name), 
            by = c('family')) %>%
  left_join(o_from_c %>% select(class = parent, order = name), 
            by = c('order')) %>%
  left_join(c_from_p %>% select(phylum = parent, class = name), 
            by = c('class')) %>%
  left_join(p_from_k %>% select(kingdom = parent, phylum = name),
            by = c('phylum')) %>%
  select(kingdom, phylum, class, order, family, genus, species) %>%
  distinct()
```

### Potential for gapfill at each rank

For each rank, identify the taxa included in vulnerability data (e.g. which genera are included in our data, based on any match level).  Count the number of species known (from vulnerability data), unknown but fillable (not specifically in vulnerability data), and unknown and unfillable (no vulnerability for that taxa).

``` {r gapfill potential by rank}

taxa_match_df <- match_vuln_df %>%
  select(kingdom:species) %>%
  distinct() %>%
  group_by(species) %>%
  slice(1) %>% ### a couple of double-counted spp
  ungroup()

taxa_all_wide <- spp_df_wide %>%
  group_by(species) %>%
  slice(1) %>%
  ungroup()
match_ranks <- c('phylum', 'class', 'order', 'family', 'genus', 'species')

rank_gapfill_potential <- vector('list', length = length(match_ranks) - 1) %>%
  setNames(match_ranks[-6])



for(r in match_ranks[-6]) { ### r <- 'phylum'
  rank_spp_known <- taxa_match_df %>%
    rename(tmp := !!r) %>%
    group_by(tmp) %>%
    summarize(n_spp_known = n_distinct(species)) %>%
    ungroup() %>%
    rename(!!r := tmp) 
  rank_spp_all <- taxa_all_wide %>%
    rename(tmp := !!r) %>%
    group_by(tmp) %>%
    summarize(n_spp_all = n_distinct(species)) %>%
    ungroup() %>%
    rename(!!r := tmp) %>%
    left_join(rank_spp_known, by = r) %>%
    mutate(n_spp_fill = ifelse(is.na(n_spp_known), 0, n_spp_all - n_spp_known))
  rank_gapfill_potential[[r]] <- rank_spp_all %>% 
    summarize(n_spp_known = sum(n_spp_known, na.rm = TRUE),
              n_spp_fill = sum(n_spp_fill),
              n_spp_unknown = sum(n_spp_all) - n_spp_known - n_spp_fill,
              n_spp_all = sum(n_spp_all),
              rank = r)
}
knitr::kable(bind_rows(rank_gapfill_potential))
  
```


#### Occurrences of duplicated species names:

``` {r}
DT::datatable(show_dupes(spp_df_wide %>% 
                                filter(!is.na(species)), 'species') %>% 
                arrange(species))
```

## create gapfill dataframes

Calculate the mean based on all $n$ known species in the rank-level grouping.  This will be broken into taxa with all vulnerability scores deterministic (i.e., no species with a distribution around its vulnerability score) and probabilistic (i.e., one or more species has a distribution around its vulnerability score).

For deterministic taxa, we can calculate a simple mean and standard deviation across vulnerability scores for all species in the taxon.

For probabilistic taxa, we will do a Monte Carlo approach, sampling species from the taxon including variation around the mean for those species with distributions around their vulnerability.

### Deterministic taxa

``` {r identify deterministic taxa-stressor instances}

gen_fill_det <- match_vuln_df %>%
  # filter(genus == 'meridiastra') %>%
  group_by(class, order, family, genus, stressor, taxon) %>%
  filter(sum(sd_vuln > 0, na.rm = TRUE) == 0) %>%
  summarize(n_known_spp = n_distinct(species),
            mean_vuln = mean(vuln),
            sd_vuln   = sd(vuln),
            # med_vuln  = median(vuln),
            # skew_vuln = psych::skew(vuln, type = 2),
            # kurt_vuln = psych::kurtosi(vuln, type = 2),
            # bimod_coef = mousetrap::bimodality_coefficient(vuln),
            gapfill = 'genus')
  
fam_fill_det <- match_vuln_df %>%
  group_by(class, order, family, stressor, taxon) %>%
  filter(sum(sd_vuln > 0, na.rm = TRUE) == 0) %>%
  summarize(n_known_spp = n_distinct(species),
            mean_vuln = mean(vuln),
            sd_vuln   = sd(vuln),
            # med_vuln  = median(vuln),
            # skew_vuln = moments::skewness(vuln),
            # kurt_vuln = moments::kurtosis(vuln),
            # bimod_coef = mousetrap::bimodality_coefficient(vuln),
            gapfill = 'family')

ord_fill_det <- match_vuln_df %>%
  group_by(class, order, stressor, taxon) %>%
  filter(sum(sd_vuln > 0, na.rm = TRUE) == 0) %>%
  summarize(n_known_spp = n_distinct(species),
            mean_vuln = mean(vuln),
            sd_vuln   = sd(vuln),
            # med_vuln  = median(vuln),
            # skew_vuln = moments::skewness(vuln),
            # kurt_vuln = moments::kurtosis(vuln),
            # bimod_coef = mousetrap::bimodality_coefficient(vuln),
            gapfill = 'order')
 
cls_fill_det <- match_vuln_df %>%
  group_by(class, stressor, taxon) %>%
  filter(sum(sd_vuln > 0, na.rm = TRUE) == 0) %>%
  summarize(n_known_spp = n_distinct(species),
            mean_vuln = mean(vuln),
            sd_vuln   = sd(vuln),
            # med_vuln  = median(vuln),
            # skew_vuln = moments::skewness(vuln),
            # kurt_vuln = moments::kurtosis(vuln),
            # bimod_coef = mousetrap::bimodality_coefficient(vuln),
            gapfill = 'class')
 
```

### Probabilistic taxa

If any species in the taxon has a distribution around its vulnerability for a stressor (i.e., sd(vulnerability) != 0), check a few things:

* `gen_fill_matchrank`: Are all species in the taxon gapfilled from this rank or a higher rank?  if so, no gapfilling is necessary, as the downstream fill has already necessarily filled all values.
* `gen_fill_nondet_solo`: Are there more than one unique value for vuln and sd_vuln among species within this rank group?  If not, then all spp have identical distributions.  In this case, it is likely that a single probabilistic species represents the entire genus (or whichever level).  Note: ignore ones entirely gapfilled from a higher level.
* `gen_fill_prob`: Leaving out groups matched at higher ranks and species with only one distinct instance of vulnerability values, these remain, with multiple species within the rank group having different vulnerability scores and distributions.

``` {r}

stressors <- match_vuln_df$stressor %>% unique() %>% sort()

```

#### Genus level

``` {r genus prob fill}
gen_fill_nondet <- match_vuln_df %>%
  # filter(genus == 'meridiastra') %>%
  group_by(class, order, family, genus, stressor, taxon) %>%
  filter(sum(sd_vuln > 0, na.rm = TRUE) > 0) %>%
  ungroup()

gen_fill_matchrank <- gen_fill_nondet %>%
  group_by(class, order, family, genus, stressor, taxon) %>%
  filter(all(match_rank %in% c('class', 'order', 'family', 'genus'))) %>%
  summarize(mean_vuln = first(vuln), 
            # med_vuln = first(vuln), 
            sd_vuln = first(sd_vuln), 
            n_known_spp = n_distinct(species)) %>%
  ungroup()

gen_fill_nondet_solo <- gen_fill_nondet %>%
  filter(!genus %in% gen_fill_matchrank$genus) %>%
  group_by(class, order, family, genus, stressor, taxon) %>%
  filter(n_distinct(vuln) == 1 & n_distinct(sd_vuln) == 1) %>%
  summarize(mean_vuln = first(vuln), 
            # med_vuln = first(vuln), 
            sd_vuln = first(sd_vuln), 
            n_known_spp = n_distinct(species)) %>%
  ungroup()
  
```

``` {r monte carlo for genus vuln dists}
gen_fill_file <- '~/git-annex/spp_vuln/gen_fill_prob_results.csv'

iters <- 1000

if(!file.exists(gen_fill_file)) {
  gen_fill_prob <- gen_fill_nondet %>%
    filter(!genus %in% c(gen_fill_matchrank$genus, gen_fill_nondet_solo$genus)) %>%
    group_by(class, order, family, genus, stressor, taxon)
    
  gen_fill_qty <- gen_fill_prob %>%
    group_by(class, order, family, genus, stressor, taxon) %>%
    summarize(n_spp = n(),
              n_prob = sum(sd_vuln > 0, na.rm = TRUE)) %>%
    filter(n_spp > 1) %>%
    ungroup()
  
  genera <- gen_fill_qty$genus %>% unique()
  genera_list <- vector('list', length = length(genera)) %>%
    setNames(genera)
  for(g in genera) { ### g <- genera[1]
    g_df <- gen_fill_prob %>%
      filter(genus == g) %>%
      mutate(sd_vuln = ifelse(is.na(sd_vuln), 0, sd_vuln))
    
    message('Running ', iters, ' MC iterations for genus ', g)
    tmp_list <- vector('list', length = iters)
    for(i in 1:iters) { ### i <- 2
      samp_df <- g_df %>%
        rowwise() %>%
        mutate(v = rnorm(1, mean = vuln, sd = sd_vuln)) %>%
        ungroup()
      tmp_list[[i]] <- samp_df
    }
    mc_results_df <- tmp_list %>%
      bind_rows() %>%
      group_by(class, order, family, genus, stressor, taxon) %>%
      summarize(mean_vuln = mean(v),
                sd_vuln = sd(v),
                # med_vuln = median(v),
                n_known_spp = n_distinct(species)) %>%
      ungroup()
    genera_list[[g]] <- mc_results_df
  }
  
  gen_fill_prob_results <- genera_list %>%
    bind_rows() %>%
    left_join(gen_fill_qty)
  
  write_csv(gen_fill_prob_results, gen_fill_file)
}
```

combine all genus-level gapfill values:
```{r}
gen_fill_prob_results <- read_csv(gen_fill_file)

gen_fill_totes <- bind_rows(gen_fill_det,
                            gen_fill_matchrank,
                            gen_fill_nondet_solo,
                            gen_fill_prob_results) %>%
  select(-n_spp) %>%
  mutate(gapfill = 'genus')
```

genus check:
```{r}
n_distinct(taxa_match_df$genus)
n_distinct(c(gen_fill_det$genus,
             gen_fill_matchrank$genus,
             gen_fill_nondet_solo$genus,
             gen_fill_prob_results$genus))

```

#### Family level

``` {r family prob fill}
fam_fill_nondet <- match_vuln_df %>%
  # filter(genus == 'meridiastra') %>%
  group_by(class, order, family, stressor, taxon) %>%
  filter(sum(sd_vuln > 0, na.rm = TRUE) > 0) %>%
  ungroup()

fam_fill_matchrank <- fam_fill_nondet %>%
  group_by(class, order, family, stressor, taxon) %>%
  filter(all(match_rank %in% c('class', 'order', 'family'))) %>%
  summarize(mean_vuln = first(vuln), 
            # med_vuln = first(vuln), 
            sd_vuln = first(sd_vuln), 
            n_known_spp = n_distinct(species)) %>%
  ungroup()

fam_fill_nondet_solo <- fam_fill_nondet %>%
  filter(!family %in% fam_fill_matchrank$family) %>%
  group_by(class, order, family, stressor, taxon) %>%
  filter(n_distinct(vuln) == 1 & n_distinct(sd_vuln) == 1) %>%
  summarize(mean_vuln = first(vuln), 
            # med_vuln = first(vuln), 
            sd_vuln = first(sd_vuln), 
            n_known_spp = n_distinct(species)) %>%
  ungroup()
```

``` {r monte carlo for fam vuln dists}
fam_fill_file <- '~/git-annex/spp_vuln/fam_fill_prob_results.csv'

if(!file.exists(fam_fill_file)) {
  fam_fill_prob <- fam_fill_nondet %>%
    filter(!family %in% c(fam_fill_matchrank$family, fam_fill_nondet_solo$family)) %>%
    group_by(class, order, family, stressor, taxon)
    
  fam_fill_qty <- fam_fill_prob %>%
    group_by(class, order, family, stressor, taxon) %>%
    summarize(n_spp = n(),
              n_prob = sum(sd_vuln > 0, na.rm = TRUE)) %>%
    filter(n_spp > 1) %>%
    ungroup()
  
  fams <- fam_fill_qty$family %>% unique()
  fam_list <- vector('list', length = length(fams)) %>%
    setNames(fams)
  for(f in fams) { ### f <- fams[1]
    f_df <- fam_fill_prob %>%
      filter(family == f) %>%
      mutate(sd_vuln = ifelse(is.na(sd_vuln), 0, sd_vuln))
    
    message('Running ', iters, ' MC iterations for family ', f)
    tmp_list <- vector('list', length = iters)
    for(i in 1:iters) { ### i <- 2
      samp_df <- f_df %>%
        rowwise() %>%
        mutate(v = rnorm(1, mean = vuln, sd = sd_vuln)) %>%
        ungroup()
      tmp_list[[i]] <- samp_df
    }
    mc_results_df <- tmp_list %>%
      bind_rows() %>%
      group_by(class, order, family, stressor, taxon) %>%
      summarize(mean_vuln = mean(v),
                sd_vuln = sd(v),
                # med_vuln = median(v),
                n_known_spp = n_distinct(species)) %>%
      ungroup()
    fam_list[[f]] <- mc_results_df
  }
  
  
  fam_fill_prob_results <- fam_list %>%
    bind_rows() %>%
    left_join(fam_fill_qty)
  
  write_csv(fam_fill_prob_results, fam_fill_file)
}
```

combine all family-level gapfill values:
```{r}
fam_fill_prob_results <- read_csv(fam_fill_file)

fam_fill_totes <- bind_rows(fam_fill_det,
                            fam_fill_matchrank,
                            fam_fill_nondet_solo,
                            fam_fill_prob_results) %>%
  select(-n_spp) %>%
  mutate(gapfill = 'family')
```

family check:
```{r}
n_distinct(taxa_match_df$family)
n_distinct(c(fam_fill_det$family,
             fam_fill_matchrank$family,
             fam_fill_nondet_solo$family,
             fam_fill_prob_results$family))

```


#### Order level

``` {r order prob fill}
ord_fill_nondet <- match_vuln_df %>%
  # filter(genus == 'meridiastra') %>%
  group_by(class, order, stressor, taxon) %>%
  filter(sum(sd_vuln > 0, na.rm = TRUE) > 0) %>%
  ungroup()

ord_fill_matchrank <- ord_fill_nondet %>%
  group_by(class, order, stressor, taxon) %>%
  filter(all(match_rank %in% c('class', 'order'))) %>%
  summarize(mean_vuln = first(vuln), 
            # med_vuln = first(vuln), 
            sd_vuln = first(sd_vuln), 
            n_known_spp = n_distinct(species)) %>%
  ungroup()

ord_fill_nondet_solo <- ord_fill_nondet %>%
  filter(!order %in% ord_fill_matchrank$order) %>%
  group_by(class, order, stressor, taxon) %>%
  filter(n_distinct(vuln) == 1 & n_distinct(sd_vuln) == 1) %>%
  summarize(mean_vuln = first(vuln), 
            # med_vuln = first(vuln), 
            sd_vuln = first(sd_vuln), 
            n_known_spp = n_distinct(species)) %>%
  ungroup()
```

``` {r monte carlo for ord vuln dists}
ord_fill_file <- '~/git-annex/spp_vuln/ord_fill_prob_results.csv'

if(!file.exists(ord_fill_file)) {
  ord_fill_prob <- ord_fill_nondet %>%
    filter(!order %in% c(ord_fill_matchrank$order, ord_fill_nondet_solo$order)) %>%
    group_by(class, order, stressor, taxon)
    
  ord_fill_qty <- ord_fill_prob %>%
    group_by(class, order, stressor, taxon) %>%
    summarize(n_spp = n(),
              n_prob = sum(sd_vuln > 0, na.rm = TRUE)) %>%
    filter(n_spp > 1) %>%
    ungroup()
  
  ords <- ord_fill_qty$order %>% unique()
  ord_list <- vector('list', length = length(ords)) %>%
    setNames(ords)
  for(o in ords) { ### o <- ords[1]
    o_df <- ord_fill_prob %>%
      filter(order == o) %>%
      mutate(sd_vuln = ifelse(is.na(sd_vuln), 0, sd_vuln))
    
    message('Running ', iters, ' MC iterations for order ', o)
    tmp_list <- vector('list', length = iters)
    for(i in 1:iters) { ### i <- 2
      samp_df <- o_df %>%
        rowwise() %>%
        mutate(v = rnorm(1, mean = vuln, sd = sd_vuln)) %>%
        ungroup()
      tmp_list[[i]] <- samp_df
    }
    mc_results_df <- tmp_list %>%
      bind_rows() %>%
      group_by(class, order, stressor, taxon) %>%
      summarize(mean_vuln = mean(v),
                sd_vuln = sd(v),
                # med_vuln = median(v),
                n_known_spp = n_distinct(species)) %>%
      ungroup()
    ord_list[[o]] <- mc_results_df
  }
  
  
  ord_fill_prob_results <- ord_list %>%
    bind_rows() %>%
    left_join(ord_fill_qty)

  write_csv(ord_fill_prob_results, ord_fill_file)
}
```

combine all order-level gapfill values:
```{r}
ord_fill_prob_results <- read_csv(ord_fill_file)

ord_fill_totes <- bind_rows(ord_fill_det,
                            ord_fill_matchrank,
                            ord_fill_nondet_solo,
                            ord_fill_prob_results) %>%
  select(-n_spp) %>%
  mutate(gapfill = 'order')


```

order check:
```{r}

n_distinct(taxa_match_df$order)
n_distinct(c(ord_fill_det$order,
             ord_fill_matchrank$order,
             ord_fill_nondet_solo$order,
             ord_fill_prob_results$order))

```

#### Class level

``` {r class prob fill}
cls_fill_nondet <- match_vuln_df %>%
  # filter(genus == 'meridiastra') %>%
  group_by(class, stressor, taxon) %>%
  filter(sum(sd_vuln > 0, na.rm = TRUE) > 0) %>%
  ungroup()

cls_fill_matchrank <- cls_fill_nondet %>%
  group_by(class, stressor, taxon) %>%
  filter(all(match_rank %in% c('class'))) %>%
  summarize(mean_vuln = first(vuln), 
            # med_vuln = first(vuln), 
            sd_vuln = first(sd_vuln), 
            n_known_spp = n_distinct(species)) %>%
  ungroup()

cls_fill_nondet_solo <- cls_fill_nondet %>%
  filter(!class %in% cls_fill_matchrank$class) %>%
  group_by(class, stressor, taxon) %>%
  filter(n_distinct(vuln) == 1 & n_distinct(sd_vuln) == 1) %>%
  summarize(mean_vuln = first(vuln), 
            # med_vuln = first(vuln), 
            sd_vuln = first(sd_vuln), 
            n_known_spp = n_distinct(species)) %>%
  ungroup()
```

``` {r monte carlo for cls vuln dists}
cls_fill_file <- '~/git-annex/spp_vuln/cls_fill_prob_results.csv'

if(!file.exists(cls_fill_file)) {
  cls_fill_prob <- cls_fill_nondet %>%
    filter(!class %in% c(cls_fill_matchrank$class, cls_fill_nondet_solo$class)) %>%
    group_by(class, stressor, taxon)
    
  cls_fill_qty <- cls_fill_prob %>%
    group_by(class, stressor, taxon) %>%
    summarize(n_spp = n(),
              n_prob = sum(sd_vuln > 0, na.rm = TRUE)) %>%
    filter(n_spp > 1) %>%
    ungroup()
  
  clss <- cls_fill_qty$class %>% unique()
  cls_list <- vector('list', length = length(clss)) %>%
    setNames(clss)
  for(c in clss) { ### c <- clss[1]
    c_df <- cls_fill_prob %>%
      filter(class == c) %>%
      mutate(sd_vuln = ifelse(is.na(sd_vuln), 0, sd_vuln))
    
    message('Running ', iters, ' MC iterations for class ', c)
    tmp_list <- vector('list', length = iters)
    for(i in 1:iters) { ### i <- 2
      samp_df <- c_df %>%
        rowwise() %>%
        mutate(v = rnorm(1, mean = vuln, sd = sd_vuln)) %>%
        ungroup()
      tmp_list[[i]] <- samp_df
    }
    mc_results_df <- tmp_list %>%
      bind_rows() %>%
      group_by(class, stressor, taxon) %>%
      summarize(mean_vuln = mean(v),
                sd_vuln = sd(v),
                # med_vuln = median(v),
                n_known_spp = n_distinct(species)) %>%
      ungroup()
    cls_list[[c]] <- mc_results_df
  }
  
  
  cls_fill_prob_results <- cls_list %>%
    bind_rows() %>%
    left_join(cls_fill_qty)
  
  write_csv(cls_fill_prob_results, cls_fill_file)
}
```

combine all class-level gapfill values:
```{r}
cls_fill_prob_results <- read_csv(cls_fill_file)

cls_fill_totes <- bind_rows(cls_fill_det,
                            cls_fill_matchrank,
                            cls_fill_nondet_solo,
                            cls_fill_prob_results) %>%
  select(-n_spp) %>%
  mutate(gapfill = 'class')
```

class check:
```{r}
n_distinct(taxa_match_df$class)
n_distinct(c(cls_fill_det$class,
             cls_fill_matchrank$class,
             cls_fill_nondet_solo$class,
             cls_fill_prob_results$class))
```

## Combine matched and gapfilled traits

Strip the higher ranks for file size; save out.
```{r combine gapfill value dataframes and save out}
vuln_all_spp <- match_vuln_df %>%
  mutate(gapfill = 'none') %>%
  bind_rows(gen_fill_totes, fam_fill_totes, ord_fill_totes, cls_fill_totes) %>%
  mutate(vuln = ifelse(is.na(vuln), mean_vuln, vuln)) %>%
  select(-mean_vuln, -kingdom, -phylum) %>%
  distinct()

### split with a taxon ID

vuln_tx <- vuln_all_spp %>%
  select(class:species, taxon, n_known_spp, n_prob, gapfill, match_rank) %>%
  distinct() %>%
  mutate(n_known_spp = ifelse(is.na(n_known_spp), 1, n_known_spp)) %>%
  arrange(class, order, family, genus, species) %>%
  mutate(tx_id = 1:n())

vuln_vals <- vuln_all_spp %>%
  left_join(vuln_tx %>% select(class:species, tx_id),
            by = c('class', 'order', 'family', 'genus', 'species')) %>%
  select(tx_id, stressor, vuln, sd_vuln) %>%
  mutate(across(where(is.numeric), ~ round(., 5)))
  
### write .csvs which can be joined using tx_id
write_csv(vuln_vals, '~/git-annex/spp_vuln/pre_gapfill/vuln_gapfill_values.csv')
write_csv(vuln_tx,   '~/git-annex/spp_vuln/pre_gapfill/vuln_gapfill_taxa.csv')
```

## Examine gapfill variability by stressor and taxon

The values in the following tables are coefficients of variation for each combination of stressor or taxon and various levels of potential gapfilling using an upstream-downstream method.
```{r}
cv_compare <- vuln_all_spp %>%
  group_by(gapfill, stressor, taxon) %>%
  mutate(cv = ifelse(vuln > 0 & !is.na(sd_vuln), sd_vuln / vuln, 0)) %>%
  summarize(mean_cv = mean(cv), n_spp = n())

cv_by_str <- cv_compare %>% 
  group_by(gapfill, stressor) %>%
  summarize(w_mean_cv = (sum(mean_cv * n_spp) / sum(n_spp)) %>% round(5)) %>%
  mutate(gapfill = factor(gapfill, levels = c('none', 'genus', 'family', 'order', 'class'))) %>%
  arrange(desc(gapfill), desc(w_mean_cv)) %>%
  spread(gapfill, w_mean_cv)

cv_by_taxon <- cv_compare %>% 
  group_by(gapfill, taxon) %>%
  summarize(w_mean_cv = (sum(mean_cv * n_spp) / sum(n_spp)) %>% round(5)) %>%
  mutate(gapfill = factor(gapfill, levels = c('none', 'genus', 'family', 'order', 'class'))) %>%
  arrange(desc(gapfill), desc(w_mean_cv)) %>%
  spread(gapfill, w_mean_cv)

knitr::kable(cv_by_str)
knitr::kable(cv_by_taxon)
```

### plot these

```{r}
lvls <- c('none', 'genus', 'family', 'order', 'class')
cv_by_str_long <- cv_by_str %>%
  gather(level, cv, none:class) %>%
  mutate(level = factor(level, levels = lvls))
ggplot(cv_by_str_long, aes(x = level, y = cv)) +
  geom_point() +
  facet_wrap(~stressor, scales = 'free_y') +
  theme(axis.text.x = element_text(angle = 90, vjust = .5)) +
  labs(title = 'coef of var by stressor and gapfill level')
```

```{r}
cv_by_taxon_long <- cv_by_taxon %>%
  gather(level, cv, none:class) %>%
  mutate(level = factor(level, levels = lvls))
ggplot(cv_by_taxon_long, aes(x = level, y = cv)) +
  geom_point() +
  facet_wrap(~taxon, scales = 'free_y') +
  theme(axis.text.x = element_text(angle = 90, vjust = .5)) +
  labs(title = 'coef of var by taxon and gapfill level')
```

## Calculate gapfill counts and taxon means/sds

First let's use the vulnerability gapfilling to fill in species up to family or order level.

```{r apply upstreamed gapfill values to downstream spp}
vuln_vals <- read_csv('~/git-annex/spp_vuln/pre_gapfill/vuln_gapfill_values.csv')
vuln_tx <- read_csv('~/git-annex/spp_vuln/pre_gapfill/vuln_gapfill_taxa.csv')
vuln_df <- vuln_tx %>%
  left_join(vuln_vals, by = 'tx_id') %>%
  select(-tx_id, -n_known_spp, -n_prob) %>%
  distinct()

vuln_direct_match <- vuln_df %>%
  filter(!is.na(match_rank))

gf_ranks <- c('species', 'genus', 'family', 'order', 'class')

gf_list <- vector('list', length = length(gf_ranks)) %>%
  setNames(gf_ranks)

gf_list[[1]] <- data.frame()

spp_done <- unique(vuln_direct_match$species)

for(i in 2:length(gf_ranks)) {
  ### i <- 3
  r <- gf_ranks[i]
  drop_ranks <- gf_ranks[c(1:(i-1))]
  rank_df <- vuln_df %>%
    filter(gapfill == r) %>%
    select(-all_of(drop_ranks)) %>%
    distinct()
  
  rank_gf_df <- spp_df_wide %>%
    filter(!species %in% spp_done) %>%
    inner_join(rank_df)
  
  spp_done <- c(spp_done, unique(rank_gf_df$species))
  
  gf_list[[i]] <- rank_gf_df
}

vuln_all_gf <- bind_rows(gf_list) %>%
  bind_rows(vuln_direct_match) %>%
  mutate(sd_vuln = ifelse(is.na(sd_vuln), 0, sd_vuln)) %>%
  select(-kingdom, -phylum)

vuln_gf_tx <- vuln_all_gf %>%
  select(class:species, taxon, gapfill, match_rank) %>%
  distinct() %>%
  arrange(species) %>%
  mutate(vuln_gf_id = 1:n())

vuln_gf_score <- vuln_all_gf %>%
  left_join(vuln_gf_tx %>% select(species, vuln_gf_id) %>% distinct(),
            by = 'species') %>%
  select(vuln_gf_id, stressor, vuln) %>%
  distinct() %>%
  mutate(vuln = round(vuln, 5))

vuln_gf_sd <- vuln_all_gf %>%
  left_join(vuln_gf_tx %>% select(species, vuln_gf_id) %>% distinct(),
            by = 'species') %>%
  select(vuln_gf_id, stressor, sd_vuln) %>%
  distinct() %>%
  mutate(sd_vuln = round(sd_vuln, 5))

  
write_csv(vuln_gf_tx, '~/git-annex/spp_vuln/post_gapfill/vuln_gapfilled_tx.csv')
write_csv(vuln_gf_score, '~/git-annex/spp_vuln/post_gapfill/vuln_gapfilled_score.csv')
write_csv(vuln_gf_sd, '~/git-annex/spp_vuln/post_gapfill/vuln_gapfilled_sd.csv')

```

### count of gapfill by taxon

Should be independent of stressor!

```{r count of gapfill status by taxon}
gf_count <- vuln_all_gf %>%
  group_by(taxon, gapfill, match_rank) %>%
  summarize(n_spp = n_distinct(species)) %>%
  ungroup() %>%
  mutate(val = case_when(gapfill == 'none' ~ paste0('match: ', match_rank),
                         TRUE ~ paste0('gapfill: ', gapfill))) %>%
  select(taxon, val, n_spp) %>%
  spread(val, n_spp)
knitr::kable(gf_count)
write_csv(gf_count, here('_output/gapfill_count.csv'))
```

### Breakdown by taxon

```{r}
set.seed(42)
mc_sample <- function(df) {
  y <- df %>%
    rowwise() %>%
    mutate(v = rnorm(1, mean = vuln, sd = sd_vuln)) %>%
    ungroup()
  return(y)
}
mc_iters <- function(df, iters = 100, mc.cores) {
  # x <- df %>%
  #   filter(sd_vuln == 0 | is.na(sd_vuln))
  # y <- df %>%
  #   filter(sd_vuln > 0)
  i <- 1:iters
  z <- parallel::mclapply(i, mc.cores = mc.cores,
          FUN = function(i) {
            mc_sample(df)
          })
  zz <- bind_rows(z) # %>%
    # group_by(class, order, family, genus, species, taxon, stressor) %>%
    # summarize(vuln = mean(v), sd_vuln = sd(v))
  return(zz)
}
```

```{r}
tx_str_sum_outfile <- here('_output/taxon_str_vuln_summary.csv')

if(!file.exists(tx_str_sum_outfile)) {
  tx <- vuln_all_gf$taxon %>% unique() %>% sort()
  str <- vuln_all_gf$stressor %>% unique() %>% sort()
  
  iters <- 100
  
  tx_list <- vector('list', length = length(tx)) %>%
    setNames(tx)
  for(t in tx) { ### t <- tx[1]
    tmp_df <- vuln_all_gf %>%
      filter(taxon == t)

    nrows <- nrow(tmp_df)
    message('Processing taxon ', t, ': nrows = ', nrow(tmp_df))
    
    str_list <- vector('list', length = length(str)) %>%
      setNames(str)
    for(s in str) { ### s <- str[1]
      tmp2_df <- tmp_df %>%
        filter(stressor == s)
      mc_tx_str_df <- mc_iters(tmp2_df, iters = iters, mc.cores = 40) %>%
        group_by(taxon, stressor) %>%
        summarize(mean_vuln = mean(v), sd_vuln = sd(v))
      str_list[[s]] <- mc_tx_str_df
    }
      
    tx_list[[t]] <- bind_rows(str_list)
  }
  
  tx_str_summary <- tx_list %>%
    bind_rows() %>%
    mutate(mean_vuln = round(mean_vuln, 5),
           sd_vuln   = round(sd_vuln,))
  write_csv(tx_str_summary, tx_str_sum_outfile)
}

tx_str_summary <- read_csv(tx_str_sum_outfile)
DT::datatable(tx_str_summary)

```

```{r}

```

