---
title: "Calculate species vulnerability from traits"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)

source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

```

# Summary

Read in taxonomic traits filled in by taxon experts and cleaned in prior scripts.  Combine with coded sensitivity, adaptive capacity, and exposure from stressor-trait sheets to calculate vulnerability.

# Data

`_raw_data/xlsx/master_all_taxa_trait_data.xlsx` is the raw workbook prepared by Nathalie Butt from the various submissions of the taxa-group experts.  This has been processed and cleaned to `_data/spp_traits_valid.csv`.  See earlier scripts in the process.

`trait_stressor_rankings/final_scores_all_stressors_traits.xlsx` is a workbook with each sheet indicating sensitivity or adaptive capacity; columns in each sheet indicate stressors, and rows indicate traits.

# Methods

## Use scored sensitivity traits to stressors against species scored to traits

Set up a function to consistently clean trait values.  Trait values in the species trait file are already cleaned and adjusted in many cases to get around mismatches; they are generally lower case, no punctuation except for greater/less than signs.

This function also cleans up category and trait names for consistency.  All lower case, punctuation and spaces replaced with underscores.  The species trait file is already cleaned in this manner.
```{r}
clean_traitnames <- function(df, overwrite_clean_col = FALSE) {
  df <- df %>% 
    mutate(category = str_replace_all(category, '[^A-Za-z0-9]+', '_') %>% tolower(),
           category = str_replace_all(category, '^_|_$', ''),
           trait    = str_replace_all(trait, '[^A-Za-z0-9]+', '_') %>% tolower(),
           trait    = str_replace_all(trait, '^_|_$', ''))
  if(!overwrite_clean_col & ('trait_value' %in% names(df))) {
      return(df) ### without overwriting existing trait_value
  }
  if(overwrite_clean_col & ('trait_value' %in% names(df))) {
    x <- readline(prompt = 'Overwriting existing trait_value column? y/n ')
    if(str_detect(x, '^n')) stop('dammit!')
  }
  ### overwrite existing, or add new
  df <- df %>%
    mutate(trait_value = str_replace_all(tolower(trait_value), '[^0-9a-z<>]', ''))
  
  return(df)
}

clean_traitvals <- function(df) {
  x <- df$trait_value
  ### First: remove numeric commas
  y <- str_replace_all(x, '(?<=[0-9]),(?=[0-9])', '') %>%
    ### then: drop all non-alphanumeric and a few key punctuation:
    str_replace_all('[^0-9a-zA-Z<>,;\\-\\.\\(\\)/ ]', '') %>% 
    ### lower case; do it after dropping any weird non-ascii characters:
    tolower() %>% 
    str_trim() %>%
    str_replace_all('n/a', 'na') %>%
    ### convert remaining commas and slashes to semicolons:
    str_replace_all('[,/]', ';') %>%
    ### drop spaces after numbers e.g. 3 mm -> 3mm:
    str_replace_all('(?<=[0-9]) ', '') %>%
    ### drop spaces before or after punctuation (non-alphanumeric):
    str_replace_all(' (?=[^a-z0-9\\(])|(?<=[^a-z0-9\\)]) ', '') %>%
    ### manually fix some valid slashes:
    str_replace_all('nearly sessile;sedentary', 'nearly sessile/sedentary') %>%
    str_replace_all('live birth;egg care', 'live birth/egg care') %>%
    str_replace_all('chitin;caco3mix', 'chitin/caco3 mix') %>%
    str_replace_all('0.5-49mm', '0.5mm-49mm')
    
  df$trait_value <- y
  return(df)
}

assign_rank_scores <- function(x) {
  y <- tolower(as.character(x))
  z <- case_when(!is.na(as.numeric(x)) ~ as.numeric(x),
                 str_detect(y, '^na')  ~ NA_real_,
                 str_detect(y, '^n')   ~ 0.00, ### none, NA, no
                 str_detect(y, '^lo')  ~ 0.33,
                 str_detect(y, '^med') ~ 0.67,
                 str_detect(y, '^hi')  ~ 1.00,
                 str_detect(y, '^y')   ~ 1.00, ### yes
                 TRUE                  ~ NA_real_) ### basically NA
  return(z)
}
```

Since the species trait file is already cleaned, DO NOT use the `clean_traitvals` function - it will overwrite the `trait_value` column.
```{r}
spp_traits <- read_csv('_data/spp_traits_valid.csv')

```

```{r}
str_trait_f <- here('_raw_data/xlsx',
                    'stressors_traits_scored.xlsx')
str_trait_shts <- readxl::excel_sheets(str_trait_f)
```

``` {r}
sens_traits_raw <- readxl::read_excel(str_trait_f, sheet = 'sensitivity') 

sens_traits_df <- sens_traits_raw %>%
  janitor::clean_names() %>%
  gather(stressor, sens_score, -category, -trait, -trait_value) %>%
  mutate(sens_score_orig = as.character(sens_score),
         sens_score = assign_rank_scores(sens_score)) %>%
  clean_traitnames() %>%
  clean_traitvals() %>%
  filter(!is.na(category)) 
  
str_sens_trait_scores <- sens_traits_df %>%
  select(category, trait, trait_value, sens_score, stressor) %>%
  mutate(sens_score = ifelse(is.na(sens_score), 0, sens_score)) %>%
  filter(!is.na(trait))

### To score for a species/stressor combo, first resolve multiple mutually
### exclusive trait values (using trait_prob) then sum across all traits
spp_sens_raw <- str_sens_trait_scores %>%
  left_join(spp_traits, by = c('category', 'trait', 'trait_value')) %>%
  filter(!is.na(stressor) & !is.na(taxon)) 

spp_sens <- spp_sens_raw %>%
  group_by(spp_gp, stressor, taxon, trait) %>%
  summarize(sens_score = sum(sens_score * trait_prob, na.rm = TRUE)) %>%
  group_by(spp_gp, stressor, taxon) %>%
  summarize(sens_score = sum(sens_score, na.rm = TRUE)) %>%
  ungroup()
```

### Check matching

Unmatched traits between sensitivity scoring sheets and species trait sheets:

```{r}
x <- spp_traits %>% select(category, trait, trait_value) %>% distinct()
y <- str_sens_trait_scores %>% select(category, trait, trait_value) %>% distinct()
```

These traits are in the species-trait scoring sheets but not found in the sensitivity trait scores (should be adaptive capacity/exposure traits only):

`r x$trait[!x$trait %in% y$trait] %>% unique()`

These traits are in the trait-sensitivity scoring sheet but not found in the species scoring (need to be scored for species):

`r y$trait[!y$trait %in% x$trait] %>% unique()`

### Sensitivity by species group and stressor

```{r}
### check odd sensitivities
noise <- spp_sens_raw %>%
  filter(stressor == 'noise_pollution') %>%
  filter(taxon %in% c('sponges', 'seabirds', 'plants_algae')) %>%
  filter(sens_score != 0)

light <- spp_sens_raw %>%
  filter(trait == 'light_dependence') %>%
  filter(stressor == 'light_pollution')
```

```{r}
p <- ggplot(spp_sens, aes(x = stressor, y = sens_score)) +
  geom_jitter(size = 1, alpha = .6, height = .1) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5, size = 6)) +
  facet_wrap(~ taxon)

ggsave(here('figs/spp_sens_scores.png'), height = 6, width = 6, dpi = 300)

knitr::include_graphics(here('figs/spp_sens_scores.png'))
```

### Sensitivity to top three stressors by taxon
```{r}
top_3_sens <- spp_sens %>%
  group_by(taxon, stressor) %>%
  summarize(sens_score = mean(sens_score) %>% round(3)) %>%
  arrange(desc(sens_score)) %>%
  group_by(taxon) %>%
  filter(sens_score >= nth(sens_score, 3))

DT::datatable(top_3_sens)
```

## Score general adaptive capacity

General adaptive capacity traits are basically related to the overall population's resilience in the face of a threat.  Large extents of occurrence, large population sizes, presence of multiple subpopulations, and reproductive strategies fall into this category.

``` {r}

adcap_gen_traits_raw <- readxl::read_excel(str_trait_f, sheet = 'gen_adcap') 


adcap_gen_traits <- adcap_gen_traits_raw %>%
  select(category, trait, trait_value, adcap_score) %>%
  # filter(trait != 'max age' & trait != 'if one/few, size') %>%
  mutate(adcap_score_orig = as.character(adcap_score),
         adcap_score = assign_rank_scores(adcap_score)) %>%
  clean_traitnames() %>%
  clean_traitvals()

spp_adcap_gen <- spp_traits %>%
  left_join(adcap_gen_traits, by = c('category', 'trait', 'trait_value')) %>%
  group_by(spp_gp, taxon) %>%
  summarize(adcap_gen_score = sum(adcap_score, na.rm = TRUE)) %>%
  ungroup()
  
# hist(spp_adcap_gen$adcap_gen_score)

```

### Check matching

Unmatched traits between general adaptive capacity scoring sheet and species trait sheets:

```{r}
x <- spp_traits %>% select(category, trait, trait_value) %>% distinct()
y <- adcap_gen_traits %>% select(category, trait, trait_value) %>% distinct()
```

Traits in species-trait sheets not in general adcap scores:
`r x$trait[!x$trait %in% y$trait] %>% unique()`

Traits in general adcap scores but not in spp traits:
`r y$trait[!y$trait %in% x$trait] %>% unique()`

```{r}
p <- ggplot(spp_adcap_gen, aes(x = taxon, y = adcap_gen_score)) +
  geom_jitter(size = 1, alpha = .6, width = .2, height = .2) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))

ggsave(here('figs/spp_adcap_gen_scores.png'), height = 4, width = 4, dpi = 300)

knitr::include_graphics(here('figs/spp_adcap_gen_scores.png'))
```

* Median: `r median(spp_adcap_gen$adcap_gen_score)`
* Mean: `r mean(spp_adcap_gen$adcap_gen_score)`
* Standard Deviation: `r sd(spp_adcap_gen$adcap_gen_score)`


## Score specific adaptive capacity

Specific adaptive capacity traits are basically related to an organism's ability to avoid or mitigate exposure, primarily through movement and larval dispersal.

``` {r}
adcap_spec_traits_raw <- readxl::read_excel(str_trait_f, sheet = 'spec_adcap') %>%
  filter(!str_detect(category, 'spatial_scale')) ### drop exposure traits

adcap_spec_traits <- adcap_spec_traits_raw %>%
  janitor::clean_names() %>%
  gather(stressor, adcap_score, -category, -trait, -trait_value) %>%
  mutate(adcap_score_orig = as.character(adcap_score),
         adcap_score = assign_rank_scores(adcap_score)) %>%
  clean_traitnames() %>%
  clean_traitvals() %>%
  filter(!is.na(trait))
  
spp_adcap_spec <- spp_traits %>%
  left_join(adcap_spec_traits, by = c('category', 'trait', 'trait_value')) %>%
  filter(!is.na(stressor)) %>%
  group_by(spp_gp, stressor, taxon) %>%
  summarize(adcap_spec_score = sum(adcap_score, na.rm = TRUE)) %>%
  ungroup()
  
# hist(spp_adcap_spec$adcap_spec_score)
# median(spp_adcap_spec$adcap_spec_score); mean(spp_adcap_spec$adcap_spec_score); sd(spp_adcap_spec$adcap_spec_score)
adcap_spec_sum <- spp_adcap_spec %>%
  group_by(stressor) %>%
  summarize(median = median(adcap_spec_score, na.rm = TRUE),
            mean   = mean(adcap_spec_score, na.rm = TRUE),
            sd     = sd(adcap_spec_score, na.rm = TRUE))
```

### Check matching

Unmatched traits between specific adaptive capacity scoring sheet and species trait sheets:

```{r}
x <- spp_traits %>% select(category, trait, trait_value) %>% distinct()
y <- adcap_spec_traits %>% select(category, trait, trait_value) %>% distinct()
```

Traits in species-trait sheets, not in specific adaptive capacity scores:

`r x$trait[!x$trait %in% y$trait] %>% unique()`

Traits in specific ad cap scores, not in spp-traits:

`r y$trait[!y$trait %in% x$trait] %>% unique()`


### specific adaptive capacity by stressor and species group

```{r}
p <- ggplot(spp_adcap_spec, aes(x = stressor, y = adcap_spec_score)) +
  geom_jitter(size = 1, alpha = .6, width = .2, height = .1) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5, size = 6)) +
  facet_wrap( ~ taxon)

ggsave(here('figs/spp_adcap_spec_scores.png'), height = 6, width = 6, dpi = 300)

knitr::include_graphics(here('figs/spp_adcap_spec_scores.png'))
```

`r knitr::kable(adcap_spec_sum)`

### Adaptive capacity to top three stressors by taxon
```{r}
top_3_adcap <- spp_adcap_spec %>%
  group_by(taxon, stressor) %>%
  summarize(adcap_score = mean(adcap_spec_score)) %>%
  arrange(desc(adcap_score)) %>%
  group_by(taxon) %>%
  filter(adcap_score >= nth(adcap_score, 3))

DT::datatable(top_3_adcap)
```

## Assign exposure potential modifier

Exposure potential modifier checks whether the depth and oceanic zones of the stressor match with the depth and oceanic zones of the species.  These fall into the "spatial scale" category with the exception of EOO.

```{r}

exp_traits_raw <- readxl::read_excel(str_trait_f, sheet = 'spec_adcap') %>%
  filter(str_detect(tolower(category), 'spatial.scale')) ### include only exposure traits

exp_traits <- exp_traits_raw %>%
  janitor::clean_names() %>%
  gather(stressor, exp_score, -category, -trait, -trait_value) %>%
  mutate(exp_score_orig = as.character(exp_score),
         exp_score = assign_rank_scores(exp_score)) %>%
  clean_traitnames()

spp_exposure <- spp_traits %>%
  full_join(exp_traits, by = c('category', 'trait', 'trait_value')) %>%
  filter(!is.na(stressor)) %>%
  group_by(spp_gp, stressor, taxon) %>%
  summarize(exposure_mod = as.integer(sum(exp_score, na.rm = TRUE) > 0)) %>%
  ungroup()  %>%
  arrange(stressor, taxon)
  
non_exposures <- spp_exposure %>% 
  group_by(taxon, stressor) %>% 
  mutate(n_gps = n_distinct(spp_gp)) %>%
  filter(exposure_mod == 0) %>% 
  summarize(n_gps_no_exp = n_distinct(spp_gp),
            n_gps = first(n_gps),
            pct_no_exp = round(n_gps_no_exp / n_gps, 3)) %>%
  arrange(stressor, desc(n_gps_no_exp)) %>%
  ungroup()

null_exposures <- spp_traits %>%
  select(spp_gp, taxon) %>%
  anti_join(spp_exposure, by = c('spp_gp', 'taxon')) %>%
  distinct()
```

### These species are not listed as potential exposure to these stressors: 

`r DT::datatable(non_exposures)`

Note: this is exposure potential only, based on overlap between species presence and stressor presence - nothing about sensitivity or actual exposure.  Check that these logic out.

### These species drop out of the exposure potential calculation

Check the spp traits for these species to identify proper assignment of at least one depth zone or ocean zone.

`r DT::datatable(null_exposures)`


## Determine habitats for habitat loss/degradation stressor

Habitat loss and degradation can be considered as an exposure variable, in the same way as potential exposure above.  However, in this case, we consider only one stressor.  

Questions to consider that will affect scoring/weighting:

### Is there an actionable difference between across-stage and within-stage dependence?
    
* Multiple habitats in the "within-stage" category seems to suggest that a species can move among habitats therefore being less sensitive to degradation of one habitat in its range.  This is a "parallel habitats" interpretation.
    * However, some species may depend on various habitats in a "series habitat" interpretation, e.g., birds that depend on one habitat type for nesting/breeding, another type for forage, and a third for stopovers in migration.  In this case, harm to any would present a bottleneck.
* Multiple habitats in the "across-stage" category seem to indicate a "series" interpretation - e.g., a fish species whose larvae grow in mangroves, then adults move to reefs.
    * However, stages could survive in multiple habitats (e.g., parallel).
* Because the trait category is not well defined, we cannot systematically distinguish between series and parallel interpretations for either across- or within-stage dependence.
* A series interpretation would sum the vulnerabilities; a parallel interpretation would take an average.  Which is most conservative?  Parallel would communicate the less alarming results, and has the advantage that it also avoids overweighting based on the number of habitats scored.

To score this we will simply lump together all unique listed habitats, regardless of within- or across-stage.  This simplifies things so we can simply calculate the habitat degradation vulnerability as normal, and append the habitat name onto the hab loss/degradation stressor name...

```{r}
spp_dep_habs <- spp_traits %>%
  filter(str_detect(trait, 'dependent_habitats')) %>%
  mutate(stressor = 'habitat_loss_degradation') %>%
  select(spp_gp, stressor, hab = trait_value) %>%
  distinct()
```

# Combine scores

We will try a calculation for vulnerability $V$ of species $i$ to stressor $j$ that basically looks like this:

$$\text{sensitivity score } S_{i,j} = \mathbf{s}_j^T \mathbf{t}_i$$
based on a vector $\mathbf{s}_j$ of trait-based sensitivity to stressor $j$, and vector $\mathbf{t}_i$ of traits of species $i$;

$$\text{specific adaptive capacity score } K_{i,j} = \mathbf{k}_j^T \mathbf{t}_i$$
based on vector $\mathbf{k}_j$ of trait-based specific adaptive capacity to stressor $j$;
$$\text{general adaptive capacity score } G_{i} = \mathbf{g}^T \mathbf{t}_i$$
based on vector $\mathbf{g}$ of trait-based general adaptive capacity; 

$$\text{exposure potential modifier } E_{i,j} = \begin{cases} 1 \text{ when }\mathbf{e}_j^T \mathbf{t}_i > 0\\ 0 \text{ else} \end{cases}$$
based on vector $\mathbf{e}_j$ of trait-based presence of stressor $j$ (i.e. depth zones and ocean zones in which stressor occurs).

$$\text{vulnerability } V_{i,j} = \frac{S_{i,j} / {S_j}'}{1 + G_i/ {G}' + K_{i,j}/ {K_j}'} \times E_{i,j}$$
Each component ($S_{i,j}, G_i, K_{i,j}$) is normalized by a reference value ($S_{j}', G', K_{j}'$ using mean, median, max, etc) for that component for that stressor across all species.  Note: median risks referencing to zero for some stressors with few sensitivities (e.g. light pollution); mean risks having a very low reference for the same.  Max risks being driven by an outlier, but here the sensitivity scores are generally capped at some low-ish value since there are a finite number of traits that can confer sensitivity.  Therefore, we will use max as the reference point.  We may wish to consider max possible, which may differ from max observed, in a future iteration?

For species groups with NA in specific adaptive capacity, force to zero (no matching adaptive traits); for species with NA in exposure potential, force to 1 (assume exposure potential).

These results will be saved by species group for now, for future matching to the species level.

```{r}

### Check that all stressors are matched to ensure proper combining of scores

exp_strs <- spp_exposure$stressor %>% unique()
sens_strs <- spp_sens$stressor %>% unique()
adcap_strs <- spp_adcap_spec$stressor %>% unique()

if(!all(exp_strs %in% sens_strs) | !all(sens_strs %in% exp_strs)) {
  stop('Mismatch between stressors in exposure traits and sensitivity traits!')
}
if(!all(adcap_strs %in% sens_strs) | !all(sens_strs %in% adcap_strs)) {
  stop('Mismatch between stressors in ad cap traits and sensitivity traits!')
}
if(!all(exp_strs %in% adcap_strs) | !all(adcap_strs %in% exp_strs)) {
  stop('Mismatch between stressors in exposure traits and ad cap traits!')
}
```

```{r}
spp_vulnerability <- spp_sens %>%
  left_join(spp_adcap_gen, by = c('taxon', 'spp_gp')) %>%
  left_join(spp_adcap_spec, by = c('taxon', 'spp_gp', 'stressor')) %>%
  left_join(spp_exposure, by = c('taxon', 'spp_gp', 'stressor')) %>%
  left_join(spp_dep_habs, by = c('spp_gp', 'stressor')) %>%
  ### fix NAs
  mutate(adcap_spec_score = ifelse(is.na(adcap_spec_score), 0, adcap_spec_score),
         exposure_mod     = ifelse(is.na(exposure_mod), 1, exposure_mod)) %>%
  rename(adcap_spec_raw = adcap_spec_score, adcap_gen_raw = adcap_gen_score, sens_raw = sens_score) %>%
  ### calculate means.  General adcap is overall; specific adcap and sensitivity are by stressor
  group_by(stressor) %>%
  mutate(max_adcap_spec = max(adcap_spec_raw),
         max_sens = max(sens_raw)) %>%
  ungroup() %>%
  mutate(max_adcap_gen = max(adcap_gen_raw)) %>%
  ### rescale components
  mutate(sens_rescale = sens_raw / max_sens,
         adcap_gen_rescale = adcap_gen_raw / max_adcap_gen,
         adcap_spec_rescale = adcap_spec_raw / max_adcap_spec) %>%
  ### note any stressors with zero for max (e.g. adcap for entanglement),
  ### will result in a NaN - convert the rescaled score to zero
  mutate(sens_rescale = ifelse(is.na(sens_rescale), 0, sens_rescale),
         adcap_gen_rescale = ifelse(is.na(adcap_gen_rescale), 0, adcap_gen_rescale),
         adcap_spec_rescale = ifelse(is.na(adcap_spec_rescale), 0, adcap_spec_rescale)) %>%
  ### mash 'em all together
  mutate(vuln = (sens_rescale / (1 + adcap_gen_rescale + adcap_spec_rescale)) * exposure_mod)

spp_vuln_rescale <- spp_vulnerability %>%
  select(-starts_with('max')) %>%
  ungroup() %>%
  mutate(vuln_raw = vuln,
         vuln = vuln_raw / max(vuln_raw))
  
write_csv(spp_vuln_rescale, here('_output/spp_gp_vulnerability.csv'))
```


### Vulnerability by spp group and stressor

``` {r, results = 'asis'}

spp_vulnerability <- read_csv('_output/spp_gp_vulnerability.csv')
plot_df <- spp_vulnerability %>% select(-hab) %>% distinct()

taxa <- plot_df$taxon %>% unique()
                
for(t in taxa) { # t <- taxa[3]
  t_vuln <- plot_df %>%
    filter(taxon == t)
  mean_str_vuln <- t_vuln %>%
    group_by(stressor) %>%
    summarize(vuln = mean(vuln))
  mean_tot_vuln <- t_vuln %>%
    summarize(vuln = mean(vuln))
  
  
  vuln_plot <- ggplot(t_vuln, 
                      aes(x = stressor, y = vuln)) +
    ggtheme_plot(base_size = 12) +
    geom_hline(data = mean_tot_vuln, aes(yintercept = vuln), color = 'red') +
    geom_jitter(size = 1, alpha = .6, width = .2, height = .02) +
    geom_point(data = mean_str_vuln, 
               shape = 21, size = 3, 
               alpha = 1, color = 'yellow', fill = 'red') +
    ylim(0, 1) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          strip.background = element_rect(fill = 'grey90')) +
    labs(title = paste0('Vulnerability: ', t))
  
  plotfile <- sprintf('figs/vuln_plot_%s.png', t)
  ggsave(plot = vuln_plot, filename = plotfile, 
         width = 8, height = 8, dpi = 300)
  cat(sprintf('![](%s)\n', plotfile))
}
# knitr::include_graphics(here('figs/vuln_plot.png'))

```

### Vulnerability by stressor across all taxa
```{r}
str_mean_vuln <- plot_df %>%
  group_by(stressor) %>%
  summarize(vuln = mean(vuln, na.rm = TRUE))
all_mean_vuln <- plot_df %>%
  summarize(vuln = mean(vuln, na.rm = TRUE))
ggplot(plot_df, aes(x = stressor, y = vuln)) +
  ggtheme_plot(base_size = 12) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5)) +
  geom_hline(data = all_mean_vuln, aes(yintercept = vuln), color = 'red') +
  geom_jitter(size = 1, alpha = .6, width = .2, height = .02) +
  geom_point(data = str_mean_vuln, 
             shape = 21, size = 3, 
             alpha = 1, color = 'yellow', fill = 'red') +
  ylim(0, 1)
```

### Vulnerability to top three stressors by taxon
```{r}
top_3_vuln <- spp_vulnerability %>%
  select(-hab) %>% distinct() %>%
  group_by(taxon, stressor) %>%
  summarize(vuln = mean(vuln)) %>%
  group_by(taxon) %>%
  arrange(taxon, desc(vuln)) %>%
  filter(vuln >= nth(vuln, 3))

knitr::kable(top_3_vuln)
```

